<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS5 Controller Debug Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ecc71;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .connect-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 30px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .connect-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #00d4ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4ff, #7b2cbf);
            border-radius: 2px;
        }

        /* æŒ‰é”®æ˜¾ç¤º */
        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .button-item {
            text-align: center;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            transition: all 0.15s ease;
            border: 2px solid transparent;
        }

        .button-item.active {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
            transform: scale(1.05);
        }

        .button-item .icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .button-item .name {
            font-size: 0.75rem;
            color: #aaa;
        }

        /* æ‘‡æ†æ˜¾ç¤º */
        .sticks-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px 0;
        }

        .stick-wrapper {
            text-align: center;
        }

        .stick-wrapper .label {
            margin-bottom: 10px;
            font-weight: bold;
            color: #00d4ff;
        }

        .stick-box {
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .stick-dot {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s ease;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .stick-values {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #888;
        }

        /* æ‰³æœºæ˜¾ç¤º */
        .triggers-container {
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
        }

        .trigger-wrapper {
            text-align: center;
            width: 45%;
        }

        .trigger-wrapper .label {
            margin-bottom: 8px;
            font-weight: bold;
        }

        .trigger-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .trigger-fill {
            height: 100%;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            border-radius: 10px;
            transition: width 0.05s ease;
            width: 0%;
        }

        .trigger-value {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #888;
        }

        /* ä¼ æ„Ÿå™¨æ•°æ® */
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .sensor-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .sensor-item .axis {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sensor-item .axis.x {
            color: #e74c3c;
        }

        .sensor-item .axis.y {
            color: #2ecc71;
        }

        .sensor-item .axis.z {
            color: #3498db;
        }

        .sensor-item .value {
            font-size: 1.2rem;
            font-family: monospace;
        }

        /* è§¦æ§æ¿ */
        .touchpad-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        .touchpad-box {
            width: 280px;
            height: 100px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .touchpad-dot {
            width: 20px;
            height: 20px;
            background: #9b59b6;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            display: none;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.8);
        }

        .touchpad-dot.active {
            display: block;
        }

        .touchpad-info {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #888;
        }

        /* æ—¥å¿—é¢æ¿ */
        .log-panel {
            grid-column: 1 / -1;
        }

        .log-container {
            height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .log-entry .time {
            color: #888;
            margin-right: 10px;
        }

        .log-entry.button {
            color: #2ecc71;
        }

        .log-entry.sensor {
            color: #3498db;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        /* LED æ§åˆ¶ */
        .led-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .led-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .led-btn:hover {
            transform: scale(1.05);
        }

        .led-btn.red {
            background: #e74c3c;
            color: white;
        }

        .led-btn.green {
            background: #2ecc71;
            color: white;
        }

        .led-btn.blue {
            background: #3498db;
            color: white;
        }

        .led-btn.purple {
            background: #9b59b6;
            color: white;
        }

        .led-btn.gold {
            background: #f1c40f;
            color: #333;
        }

        /* éœ‡åŠ¨æ§åˆ¶ */
        .vibration-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .vibration-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .vibration-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ® PS5 Controller Debug Panel</h1>
            <p>WebHID å®æ—¶è°ƒè¯•ç•Œé¢ - æŒ‰é”®ç»‘å®šä¸ä¼ æ„Ÿå™¨æ•°æ®</p>
        </header>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">æœªè¿æ¥</span>
            </div>
            <button class="connect-btn" id="connect-btn">ğŸ® è¿æ¥ PS5 æ‰‹æŸ„</button>
        </div>

        <div class="grid">
            <!-- åŠ¨ä½œæŒ‰é”® -->
            <div class="panel">
                <h2>åŠ¨ä½œæŒ‰é”®</h2>
                <div class="buttons-grid">
                    <div class="button-item" id="btn-triangle">
                        <div class="icon">â–³</div>
                        <div class="name">Triangle</div>
                    </div>
                    <div class="button-item" id="btn-circle">
                        <div class="icon">â—‹</div>
                        <div class="name">Circle</div>
                    </div>
                    <div class="button-item" id="btn-cross">
                        <div class="icon">âœ•</div>
                        <div class="name">Cross</div>
                    </div>
                    <div class="button-item" id="btn-square">
                        <div class="icon">â–¡</div>
                        <div class="name">Square</div>
                    </div>
                </div>
            </div>

            <!-- æ–¹å‘é”® -->
            <div class="panel">
                <h2>æ–¹å‘é”® D-Pad</h2>
                <div class="buttons-grid">
                    <div class="button-item" id="btn-dpad-up">
                        <div class="icon">â¬†</div>
                        <div class="name">Up</div>
                    </div>
                    <div class="button-item" id="btn-dpad-down">
                        <div class="icon">â¬‡</div>
                        <div class="name">Down</div>
                    </div>
                    <div class="button-item" id="btn-dpad-left">
                        <div class="icon">â¬…</div>
                        <div class="name">Left</div>
                    </div>
                    <div class="button-item" id="btn-dpad-right">
                        <div class="icon">â¡</div>
                        <div class="name">Right</div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»ŸæŒ‰é”® -->
            <div class="panel">
                <h2>ç³»ç»ŸæŒ‰é”®</h2>
                <div class="buttons-grid">
                    <div class="button-item" id="btn-l1">
                        <div class="icon">L1</div>
                        <div class="name">Left Bumper</div>
                    </div>
                    <div class="button-item" id="btn-r1">
                        <div class="icon">R1</div>
                        <div class="name">Right Bumper</div>
                    </div>
                    <div class="button-item" id="btn-l3">
                        <div class="icon">L3</div>
                        <div class="name">Left Stick</div>
                    </div>
                    <div class="button-item" id="btn-r3">
                        <div class="icon">R3</div>
                        <div class="name">Right Stick</div>
                    </div>
                    <div class="button-item" id="btn-options">
                        <div class="icon">â˜°</div>
                        <div class="name">Options</div>
                    </div>
                    <div class="button-item" id="btn-share">
                        <div class="icon">â™</div>
                        <div class="name">Create</div>
                    </div>
                    <div class="button-item" id="btn-ps">
                        <div class="icon">â“Ÿ</div>
                        <div class="name">PS</div>
                    </div>
                    <div class="button-item" id="btn-touchpad">
                        <div class="icon">â–­</div>
                        <div class="name">Touchpad</div>
                    </div>
                </div>
            </div>

            <!-- æ‘‡æ† -->
            <div class="panel">
                <h2>æ¨¡æ‹Ÿæ‘‡æ†</h2>
                <div class="sticks-container">
                    <div class="stick-wrapper">
                        <div class="label">å·¦æ‘‡æ†</div>
                        <div class="stick-box">
                            <div class="stick-dot" id="left-stick-dot"></div>
                        </div>
                        <div class="stick-values" id="left-stick-values">X: 0.00 Y: 0.00</div>
                    </div>
                    <div class="stick-wrapper">
                        <div class="label">å³æ‘‡æ†</div>
                        <div class="stick-box">
                            <div class="stick-dot" id="right-stick-dot"></div>
                        </div>
                        <div class="stick-values" id="right-stick-values">X: 0.00 Y: 0.00</div>
                    </div>
                </div>
            </div>

            <!-- æ‰³æœº -->
            <div class="panel">
                <h2>æ‰³æœº Triggers</h2>
                <div class="triggers-container">
                    <div class="trigger-wrapper">
                        <div class="label">L2</div>
                        <div class="trigger-bar">
                            <div class="trigger-fill" id="l2-fill"></div>
                        </div>
                        <div class="trigger-value" id="l2-value">0%</div>
                    </div>
                    <div class="trigger-wrapper">
                        <div class="label">R2</div>
                        <div class="trigger-bar">
                            <div class="trigger-fill" id="r2-fill"></div>
                        </div>
                        <div class="trigger-value" id="r2-value">0%</div>
                    </div>
                </div>
            </div>

            <!-- é™€èºä»ª -->
            <div class="panel">
                <h2>é™€èºä»ª Gyroscope</h2>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="axis x">X</div>
                        <div class="value" id="gyro-x">0</div>
                    </div>
                    <div class="sensor-item">
                        <div class="axis y">Y</div>
                        <div class="value" id="gyro-y">0</div>
                    </div>
                    <div class="sensor-item">
                        <div class="axis z">Z</div>
                        <div class="value" id="gyro-z">0</div>
                    </div>
                </div>
            </div>

            <!-- åŠ é€Ÿåº¦è®¡ -->
            <div class="panel">
                <h2>åŠ é€Ÿåº¦è®¡ Accelerometer</h2>
                <div class="sensor-grid">
                    <div class="sensor-item">
                        <div class="axis x">X</div>
                        <div class="value" id="accel-x">0</div>
                    </div>
                    <div class="sensor-item">
                        <div class="axis y">Y</div>
                        <div class="value" id="accel-y">0</div>
                    </div>
                    <div class="sensor-item">
                        <div class="axis z">Z</div>
                        <div class="value" id="accel-z">0</div>
                    </div>
                </div>
            </div>

            <!-- è§¦æ§æ¿ -->
            <div class="panel">
                <h2>è§¦æ§æ¿ Touchpad</h2>
                <div class="touchpad-container">
                    <div class="touchpad-box">
                        <div class="touchpad-dot" id="touch1"></div>
                        <div class="touchpad-dot" id="touch2"></div>
                    </div>
                    <div class="touchpad-info" id="touchpad-info">æœªè§¦æ‘¸</div>
                </div>
            </div>

            <!-- LED æ§åˆ¶ -->
            <div class="panel">
                <h2>LED é¢œè‰²æ§åˆ¶</h2>
                <div class="led-controls">
                    <button class="led-btn red" onclick="setLED(255, 0, 0)">çº¢è‰²</button>
                    <button class="led-btn green" onclick="setLED(0, 255, 0)">ç»¿è‰²</button>
                    <button class="led-btn blue" onclick="setLED(0, 0, 255)">è“è‰²</button>
                    <button class="led-btn purple" onclick="setLED(128, 0, 255)">ç´«è‰²</button>
                    <button class="led-btn gold" onclick="setLED(255, 215, 0)">é‡‘è‰²</button>
                </div>
            </div>

            <!-- éœ‡åŠ¨æ§åˆ¶ -->
            <div class="panel">
                <h2>éœ‡åŠ¨æµ‹è¯•</h2>
                <div class="vibration-controls">
                    <button class="vibration-btn" onclick="vibrate(0.2, 0.2, 100)">è½»éœ‡</button>
                    <button class="vibration-btn" onclick="vibrate(0.5, 0.5, 150)">ä¸­éœ‡</button>
                    <button class="vibration-btn" onclick="vibrate(0.8, 0.8, 200)">å¼ºéœ‡</button>
                    <button class="vibration-btn" onclick="vibrate(1.0, 0.0, 200)">å·¦é©¬è¾¾</button>
                    <button class="vibration-btn" onclick="vibrate(0.0, 1.0, 200)">å³é©¬è¾¾</button>
                </div>
            </div>

            <!-- æ—¥å¿— -->
            <div class="panel log-panel">
                <h2 style="display: flex; justify-content: space-between; align-items: center;">
                    äº‹ä»¶æ—¥å¿—
                    <button id="debug-toggle-btn"
                        style="font-size: 0.8rem; padding: 5px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: #aaa; cursor: pointer;">
                        ğŸ å¼€å¯ Debug æ—¥å¿—
                    </button>
                </h2>
                <div class="log-container" id="log-container"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import PS5ControllerWebHID from './js/ps5ControllerWebHID.js';

        let controller = null;
        let debugEnabled = false;
        const logContainer = document.getElementById('log-container');

        // Toggle Debug
        document.getElementById('debug-toggle-btn').addEventListener('click', (e) => {
            if (!controller) return;
            debugEnabled = !debugEnabled;
            controller.setDebug(debugEnabled);
            e.target.textContent = debugEnabled ? 'ğŸ å…³é—­ Debug æ—¥å¿—' : 'ğŸ å¼€å¯ Debug æ—¥å¿—';
            e.target.style.color = debugEnabled ? '#2ecc71' : '#aaa';
            log(debugEnabled ? 'Debug æ¨¡å¼å·²å¼€å¯ (æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°)' : 'Debug æ¨¡å¼å·²å…³é—­');
        });

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="time">[${time}]</span>${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);

            // é™åˆ¶æ—¥å¿—æ¡æ•°
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // æŒ‰é”®IDæ˜ å°„
        const buttonMap = {
            'cross': 'btn-cross',
            'circle': 'btn-circle',
            'square': 'btn-square',
            'triangle': 'btn-triangle',
            'L1': 'btn-l1',
            'R1': 'btn-r1',
            'L3': 'btn-l3',
            'R3': 'btn-r3',
            'options': 'btn-options',
            'share': 'btn-share',
            'ps': 'btn-ps',
            'touchpad_press': 'btn-touchpad',
            'dpad_up': 'btn-dpad-up',
            'dpad_down': 'btn-dpad-down',
            'dpad_left': 'btn-dpad-left',
            'dpad_right': 'btn-dpad-right'
        };

        // æ›´æ–°æŒ‰é”®çŠ¶æ€
        function updateButton(name, active) {
            const id = buttonMap[name];
            if (id) {
                const el = document.getElementById(id);
                if (el) {
                    if (active) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                }
            }
        }

        // æ›´æ–°æ‘‡æ†æ˜¾ç¤º
        function updateStick(side, x, y) {
            const dot = document.getElementById(`${side}-stick-dot`);
            const values = document.getElementById(`${side}-stick-values`);

            if (dot) {
                // å°† -1~1 çš„å€¼è½¬æ¢ä¸ºä½ç½®ç™¾åˆ†æ¯”
                const posX = 50 + x * 40;
                const posY = 50 + y * 40;
                dot.style.left = `${posX}%`;
                dot.style.top = `${posY}%`;
            }

            if (values) {
                values.textContent = `X: ${x.toFixed(2)} Y: ${y.toFixed(2)}`;
            }
        }

        // æ›´æ–°æ‰³æœºæ˜¾ç¤º
        function updateTrigger(side, value) {
            const fill = document.getElementById(`${side}-fill`);
            const valueEl = document.getElementById(`${side}-value`);

            const percent = Math.round(value * 100);
            if (fill) fill.style.width = `${percent}%`;
            if (valueEl) valueEl.textContent = `${percent}%`;
        }

        // æ›´æ–°ä¼ æ„Ÿå™¨æ˜¾ç¤º
        function updateSensor(type, x, y, z) {
            document.getElementById(`${type}-x`).textContent = x.toFixed(1);
            document.getElementById(`${type}-y`).textContent = y.toFixed(1);
            document.getElementById(`${type}-z`).textContent = z.toFixed(1);
        }



        // è¿æ¥æŒ‰é’®
        document.getElementById('connect-btn').addEventListener('click', async () => {
            const btn = document.getElementById('connect-btn');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');

            if (controller && controller.connected) {
                controller.disconnect();
                dot.classList.remove('connected');
                text.textContent = 'å·²æ–­å¼€';
                btn.textContent = 'ğŸ® è¿æ¥ PS5 æ‰‹æŸ„';
                log('æ‰‹æŸ„å·²æ–­å¼€', 'error');
                return;
            }

            try {
                btn.textContent = 'â³ è¿æ¥ä¸­...';
                btn.disabled = true;

                controller = new PS5ControllerWebHID();

                // ç›‘å¬æŒ‰é”®äº‹ä»¶
                controller.on('buttonPress', (name) => {
                    updateButton(name, true);
                    log(`æŒ‰é”®æŒ‰ä¸‹: ${name}`, 'button');
                });

                controller.on('buttonRelease', (name) => {
                    updateButton(name, false);
                });

                controller.on('touchpadPress', () => {
                    updateButton('touchpad_press', true);
                    log('è§¦æ§æ¿æŒ‰ä¸‹', 'button');
                });

                controller.on('touchpadRelease', () => {
                    updateButton('touchpad_press', false);
                });

                controller.on('connected', () => {
                    dot.classList.add('connected');
                    text.textContent = 'å·²è¿æ¥';
                    log('æ‰‹æŸ„å·²è¿æ¥', 'button');
                });

                controller.on('disconnected', () => {
                    dot.classList.remove('connected');
                    text.textContent = 'å·²æ–­å¼€';
                    log('æ‰‹æŸ„å·²æ–­å¼€', 'error');
                });

                await controller.connect();

                btn.textContent = 'ğŸ”Œ æ–­å¼€è¿æ¥';
                btn.disabled = false;

                // å¼€å§‹è½®è¯¢æ›´æ–°
                startPolling();

            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                btn.textContent = 'ğŸ® è¿æ¥ PS5 æ‰‹æŸ„';
                btn.disabled = false;
            }
        });

        // è½®è¯¢æ›´æ–°çŠ¶æ€
        function startPolling() {
            function poll() {
                if (!controller || !controller.connected) return;

                const state = controller.getState();
                if (state) {
                    // æ›´æ–°æ‘‡æ†
                    const left = controller.getLeftStick();
                    const right = controller.getRightStick();
                    updateStick('left', left.x, left.y);
                    updateStick('right', right.x, right.y);

                    // æ›´æ–°æ‰³æœº
                    const triggers = controller.getTriggers();
                    updateTrigger('l2', triggers.l2);
                    updateTrigger('r2', triggers.r2);

                    // æ›´æ–°ä¼ æ„Ÿå™¨
                    const gyro = controller.getGyro();
                    const accel = controller.getAccel();
                    if (gyro) updateSensor('gyro', gyro.x, gyro.y, gyro.z);
                    if (accel) updateSensor('accel', accel.x, accel.y, accel.z);

                    // æ›´æ–°è§¦æ§æ¿
                    const touchpad = controller.getTouchpad();
                    if (touchpad) {
                        if (touchpad.touches && touchpad.touches.length > 0) {
                            updateTouchpad(touchpad.touches);
                        } else if (touchpad.touching) {
                            updateTouchpad([touchpad]); // Compat for simple structure
                        } else {
                            updateTouchpad([]);
                        }
                    }
                }

                requestAnimationFrame(poll);
            }

            poll();
        }

        // æ›´æ–°è§¦æ§æ¿æ˜¾ç¤º
        function updateTouchpad(touches) {
            const points = [document.getElementById('touch1'), document.getElementById('touch2')];
            const info = document.getElementById('touchpad-info');

            let activeCount = 0;
            let infoText = 'æœªè§¦æ‘¸';

            if (touches && touches.length > 0) {
                activeCount = touches.length;
                infoText = touches.map((t, i) => `T${i + 1}:(${t.x.toFixed(2)},${t.y.toFixed(2)})`).join(' ');

                touches.forEach((t, i) => {
                    if (i < points.length) {
                        const el = points[i];
                        el.classList.add('active');
                        // Convert normalized (-1 to 1) to percentage (0 to 100)
                        const xPct = (t.x + 1) / 2 * 100;
                        const yPct = (t.y + 1) / 2 * 100;
                        el.style.left = `${xPct}%`;
                        el.style.top = `${yPct}%`;
                    }
                });
            }

            // Hide unused points
            for (let i = activeCount; i < points.length; i++) {
                points[i].classList.remove('active');
            }

            info.textContent = activeCount > 0 ? infoText : 'æœªè§¦æ‘¸';
        }

        // æš´éœ²å…¨å±€å‡½æ•°ç»™LEDå’Œéœ‡åŠ¨æŒ‰é’®
        window.setLED = (r, g, b) => {
            if (controller && controller.connected) {
                controller.setLED(r, g, b);
                log(`LED è®¾ç½®ä¸º RGB(${r}, ${g}, ${b})`, 'sensor');
            }
        };

        window.vibrate = (left, right, duration) => {
            if (controller && controller.connected) {
                controller.vibrate(left, right, duration);
                log(`éœ‡åŠ¨: L=${left} R=${right} ${duration}ms`, 'sensor');
            }
        };

        log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»è¿æ¥æŒ‰é’®');
    </script>
</body>

</html>