<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>PS5 æ‰‹æŸ„ WebHID ä¸“ç”¨è°ƒè¯•å™¨</title>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: 'Segoe UI', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            color: #00ffcc;
            margin-bottom: 10px;
        }

        .warning {
            background: #003333;
            color: #00ffcc;
            padding: 10px;
            border: 1px solid #00ffcc;
            margin-bottom: 20px;
            font-size: 14px;
            max-width: 800px;
        }

        button {
            padding: 10px 20px;
            background: #0088cc;
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }

        button:hover {
            background: #00aaff;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            max-width: 1000px;
        }

        .panel {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .panel h3 {
            color: #aaa;
            margin: 0 0 10px 0;
            font-size: 16px;
            border-bottom: 1px solid #444;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
        }

        /* è§¦æ§æ¿åŒºåŸŸ (åŠ å®½) */
        .panel.wide {
            width: 620px;
        }

        #touchpad-container {
            position: relative;
            width: 600px;
            height: 300px;
            background: #333;
            border: 2px solid #555;
            border-radius: 10px;
            overflow: hidden;
        }

        .touch-point {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        #touch1 {
            background: rgba(0, 255, 204, 0.8);
            border: 2px solid #fff;
            box-shadow: 0 0 10px #00ffcc;
        }

        #touch2 {
            background: rgba(255, 0, 100, 0.8);
            border: 2px solid #fff;
            box-shadow: 0 0 10px #ff0064;
        }

        /* æ–°å¢ç¬¬ä¸‰æŒ‡æ ·å¼ */
        #touch3 {
            background: rgba(255, 255, 0, 0.8);
            border: 2px solid #fff;
            box-shadow: 0 0 10px #ffff00;
        }

        /* 3D å§¿æ€å±•ç¤º */
        .scene {
            width: 150px;
            height: 150px;
            perspective: 400px;
            margin: 20px;
        }

        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(0deg) rotateY(0deg);
            transition: transform 0.1s;
        }

        .face {
            position: absolute;
            width: 150px;
            height: 150px;
            border: 2px solid #00ffcc;
            opacity: 0.6;
            background: rgba(0, 255, 204, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
        }

        .face.front {
            transform: translateZ(75px);
        }

        .face.back {
            transform: rotateY(180deg) translateZ(75px);
        }

        .face.right {
            transform: rotateY(90deg) translateZ(75px);
            background: rgba(255, 0, 100, 0.1);
            border-color: #ff0064;
        }

        .face.left {
            transform: rotateY(-90deg) translateZ(75px);
            background: rgba(255, 0, 100, 0.1);
            border-color: #ff0064;
        }

        .face.top {
            transform: rotateX(90deg) translateZ(75px);
            background: rgba(255, 255, 0, 0.1);
            border-color: #ffff00;
        }

        .face.bottom {
            transform: rotateX(-90deg) translateZ(75px);
            background: rgba(255, 255, 0, 0.1);
            border-color: #ffff00;
        }

        .sensor-vals {
            font-size: 12px;
            color: #888;
            font-family: monospace;
            width: 100%;
        }

        .val-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        /* éº¦å…‹é£æ¡ */
        #mic-bar-container {
            width: 100%;
            height: 20px;
            background: #111;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
            border: 1px solid #555;
        }

        #mic-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.05s;
        }

        #data-log {
            width: 100%;
            max-width: 960px;
            height: 60px;
            background: #000;
            border: 1px solid #444;
            font-family: monospace;
            color: #0f0;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            overflow-y: auto;
        }

        .disabled-text {
            color: #555;
            font-style: italic;
        }
    </style>
</head>

<body>

    <h1>PS5 æ‰‹æŸ„ WebHID ä¸“ç”¨è°ƒè¯•å™¨ <span id="connection-status" style="font-size:14px; color:#666">(æœªè¿æ¥)</span></h1>

    <div class="warning">
        âš ï¸ <b>çº¯å‡€æ¨¡å¼è¯´æ˜ï¼š</b><br>
        æœ¬ä»£ç ä»…åŒ…å« <b>WebHID</b> æ ¸å¿ƒé€»è¾‘ï¼Œä¸åŒ…å«æ ‡å‡† API é™çº§ä»£ç ã€‚<br>
        è¯·åŠ¡å¿…é€šè¿‡ <b>USB è¿æ¥</b> å¹¶åœ¨ <b>æœ¬åœ° HTML æ–‡ä»¶</b> ä¸­è¿è¡Œï¼Œå¦åˆ™æ— æ³•è·å–ç¡¬ä»¶æƒé™ã€‚
    </div>

    <div class="dashboard">

        <!-- è§¦æ§æ¿é¢æ¿ -->
        <div class="panel wide">
            <h3>è§¦æ§æ¿ (Touchpad) - å¤šç‚¹æµ‹è¯•</h3>
            <div id="touchpad-container">
                <div id="touch1" class="touch-point"></div>
                <div id="touch2" class="touch-point"></div>
                <!-- æ–°å¢ç¬¬ä¸‰æŒ‡ -->
                <div id="touch3" class="touch-point"></div>
                <div style="position: absolute; bottom: 10px; left: 10px; color: #555; pointer-events: none;">DualSense
                    Touch Area</div>
            </div>
        </div>

        <!-- ä¼ æ„Ÿå™¨é¢æ¿ -->
        <div class="panel">
            <h3>ä½“æ„Ÿå§¿æ€ (Motion)</h3>
            <div id="sensor-visual" class="scene">
                <div id="cube" class="cube">
                    <div class="face front">F</div>
                    <div class="face back">B</div>
                    <div class="face right">R</div>
                    <div class="face left">L</div>
                    <div class="face top">T</div>
                    <div class="face bottom">Btm</div>
                </div>
            </div>
            <div id="sensor-data" class="sensor-vals">
                <div class="disabled-text" style="text-align:center; padding: 20px;">ç­‰å¾…è®¾å¤‡è¿æ¥...</div>
            </div>
        </div>

        <!-- éº¦å…‹é£é¢æ¿ -->
        <div class="panel">
            <h3>éº¦å…‹é£ (Microphone)</h3>
            <button id="btn-mic" onclick="initMic()">ğŸ™ï¸ å¯ç”¨éº¦å…‹é£</button>
            <div id="mic-status" style="font-size:12px; color:#888; margin-top:5px">æœªå¯åŠ¨</div>
            <div id="mic-bar-container">
                <div id="mic-bar"></div>
            </div>
        </div>

    </div>

    <div style="margin-top: 20px;">
        <button onclick="connectHandler()" style="font-size: 16px; padding: 12px 30px;">âš¡ è¿æ¥ PS5 æ‰‹æŸ„ (WebHID)</button>
    </div>

    <div id="data-log">ç³»ç»Ÿå°±ç»ª...</div>

    <script>
        let device;

        // éŸ³é¢‘ç›¸å…³
        let audioContext;
        let analyser;
        let micStream;

        async function connectHandler() {
            try {
                if (!navigator.hid) throw new Error("æµè§ˆå™¨ä¸æ”¯æŒ WebHID API");

                const filters = [{ vendorId: 0x054c, productId: 0x0ce6 }];
                const devices = await navigator.hid.requestDevice({ filters });

                if (devices.length > 0) {
                    device = devices[0];
                    await device.open();
                    device.addEventListener("inputreport", handleInput);
                    await initDevice(); // æ¿€æ´»ä¼ æ„Ÿå™¨

                    // æ›´æ–° UI
                    document.getElementById('connection-status').innerText = "(å·²è¿æ¥)";
                    document.getElementById('connection-status').style.color = "#0f0";
                    document.getElementById('sensor-data').innerHTML = ""; // æ¸…é™¤ç­‰å¾…æ–‡å­—

                    log(`è¿æ¥æˆåŠŸ: ${device.productName}`);
                }
            } catch (err) {
                console.error(err);
                log(`è¿æ¥å¤±è´¥: ${err.message}`);
                alert(`è¿æ¥é”™è¯¯:\n${err.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. æ˜¯å¦ä½¿ç”¨ Chrome/Edge\n2. æ˜¯å¦åœ¨æœ¬åœ°ç›´æ¥è¿è¡Œ HTML æ–‡ä»¶ (é iframe/æ²™ç®±)`);
            }
        }

        // --- WebHID é€»è¾‘ ---
        async function initDevice() {
            // å‘é€ Feature Report æ¿€æ´»é«˜çº§æ¨¡å¼
            const data = new Uint8Array(47).fill(0);
            data[0] = 0x02;
            data[1] = 0xFF; // Flags
            data[42] = 0; data[43] = 255; data[44] = 0; // LED è®¾ä¸ºç»¿è‰²
            try { await device.sendReport(0x02, data); } catch (e) { }
        }

        function handleInput(event) {
            const { data, reportId } = event;
            if (reportId !== 0x01) return;

            // Offset ä¿®æ­£ï¼šåˆ¤æ–­æ•°æ®åŒ…æ˜¯å¦åŒ…å« ReportID
            let offset = 0;
            if (data.getUint8(0) === 0x01) offset = 1;

            // 1. å¤„ç†è§¦æ§ (Bytes 32+)
            // Touch 1: Offset 32 (33 with ID)
            processTouch(data, 32 + offset, 'touch1');

            // Touch 2: Offset 36 (37 with ID)
            processTouch(data, 36 + offset, 'touch2');

            // Touch 3: Offset 40 (41 with ID)
            // æ³¨æ„ï¼šDualSense æ ‡å‡†åè®®é€šå¸¸åªå‘2ä¸ªç‚¹ï¼Œè¿™é‡Œå°è¯•è¯»å–ç´§éšå…¶åçš„4å­—èŠ‚
            processTouch(data, 40 + offset, 'touch3');

            // 2. å¤„ç†ä¼ æ„Ÿå™¨ (Bytes 16-27)
            if (data.byteLength >= 28 + offset) {
                processSensors(data, offset);
            }
        }

        function processTouch(data, startIndex, elementId) {
            const el = document.getElementById(elementId);
            // å®‰å…¨æ£€æŸ¥
            if (data.byteLength < startIndex + 4) return;

            const info = data.getUint8(startIndex);
            // æœ€é«˜ä½(bit 7)ä¸º0è¡¨ç¤º Active (æœ‰è§¦æ§)
            // æ³¨æ„ï¼šå¦‚æœè¯»å–åˆ°çš„æ˜¯å…¨0æ•°æ®(0x00)ï¼Œä¹Ÿä¼šåˆ¤å®šä¸º Activeï¼Œåæ ‡(0,0)
            // è¿™å¯èƒ½ä¼šåœ¨å·¦ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ªâ€œé¬¼å½±â€ç‚¹ï¼Œè¿™æ˜¯é¢„æœŸå†…çš„è°ƒè¯•è¡Œä¸º
            const isActive = !(info & 0x80);

            if (isActive) {
                const b1 = data.getUint8(startIndex + 1);
                const b2 = data.getUint8(startIndex + 2);
                const b3 = data.getUint8(startIndex + 3);

                // è§£æ 12-bit åæ ‡
                const x = ((b2 & 0x0F) << 8) | b1;
                const y = (b3 << 4) | ((b2 & 0xF0) >> 4);

                // æ˜ å°„åˆ° UI å°ºå¯¸ (PS5è§¦æ§æ¿åˆ†è¾¨ç‡çº¦ä¸º 1920x1080)
                const uiX = (x / 1920) * 600;
                const uiY = (y / 1080) * 300;

                el.style.display = 'block';
                el.style.left = uiX + 'px';
                el.style.top = uiY + 'px';
            } else {
                el.style.display = 'none';
            }
        }

        function processSensors(data, offset) {
            // æ•°æ®æ ¼å¼: Int16 LE (å°ç«¯åº)
            const gx = data.getInt16(16 + offset, true);
            const gy = data.getInt16(18 + offset, true);
            const gz = data.getInt16(20 + offset, true);
            const ax = data.getInt16(22 + offset, true);
            const ay = data.getInt16(24 + offset, true);
            const az = data.getInt16(26 + offset, true);

            // æ›´æ–° UI æ•°å€¼
            const html = `
                <div class="val-row"><span>Gyro X:</span><span>${gx}</span></div>
                <div class="val-row"><span>Gyro Y:</span><span>${gy}</span></div>
                <div class="val-row"><span>Gyro Z:</span><span>${gz}</span></div>
                <hr style="border-color:#444; margin:2px 0">
                <div class="val-row"><span>Accel X:</span><span>${ax}</span></div>
                <div class="val-row"><span>Accel Y:</span><span>${ay}</span></div>
                <div class="val-row"><span>Accel Z:</span><span>${az}</span></div>
            `;
            document.getElementById('sensor-data').innerHTML = html;

            // æ›´æ–° 3D ç«‹æ–¹ä½“å§¿æ€ (ç®€å•çš„é‡åŠ›æ„Ÿåº”æ˜ å°„)
            const rotX = (ay / 8000) * 90;
            const rotY = (ax / 8000) * 90;
            const cube = document.getElementById('cube');
            cube.style.transform = `rotateX(${rotX}deg) rotateY(0deg) rotateZ(${-rotY}deg)`;
        }

        // --- éº¦å…‹é£é€»è¾‘ (Audio API) ---
        async function initMic() {
            const btn = document.getElementById('btn-mic');
            const status = document.getElementById('mic-status');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 32;

                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                micStream = stream;
                status.innerText = "ç›‘å¬ä¸­...";
                btn.disabled = true;
                btn.innerText = "éº¦å…‹é£å·²å¯åŠ¨";

                startMicVisualizer();
                log("éº¦å…‹é£åˆå§‹åŒ–æˆåŠŸ");

            } catch (err) {
                console.error(err);
                status.innerText = "å¯åŠ¨å¤±è´¥";
                log("éº¦å…‹é£é”™è¯¯: " + err.message);
            }
        }

        function startMicVisualizer() {
            const bar = document.getElementById('mic-bar');
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                if (!micStream) return;
                requestAnimationFrame(draw);

                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
                const average = sum / bufferLength;

                let pct = (average / 128) * 100;
                if (pct > 100) pct = 100;
                bar.style.width = pct + '%';
            }
            draw();
        }

        function log(msg) {
            const el = document.getElementById('data-log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML = `[${time}] ${msg}<br>` + el.innerHTML;
        }

    </script>
</body>

</html>