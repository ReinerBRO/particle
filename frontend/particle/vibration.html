<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>PS5 è§¦æ§æ¿å›¾ç‰‡ç¼©æ”¾æ¼”ç¤º</title>
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            color: #00ffcc;
        }

        #status-bar {
            font-family: monospace;
            font-size: 14px;
            color: #aaa;
        }

        button {
            padding: 8px 20px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #00aaff;
        }

        /* å›¾ç‰‡å®¹å™¨ */
        #viewport {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 30px 30px;
            /* ç½‘æ ¼èƒŒæ™¯ */
            position: relative;
        }

        /* å›¾ç‰‡æœ¬èº« */
        #target-image {
            max-width: 80%;
            max-height: 80%;
            /* å…³é”®ï¼šè®¾ç½®å˜æ¢åŸç‚¹ä¸ºä¸­å¿ƒï¼Œç¡®ä¿ç¼©æ”¾æ—¶ä»¥ä¸­å¿ƒä¸ºåŸºå‡† */
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            /* é»˜è®¤æ— è¿‡æ¸¡ï¼ŒJSæ§åˆ¶åŠ¨æ€è¿‡æ¸¡ */
            transition: none;
            will-change: transform;
            user-select: none;
            -webkit-user-drag: none;
        }

        /* è§¦æ§å…‰æ ‡ (è°ƒè¯•ç”¨) */
        .cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            z-index: 200;
        }

        #cursor1 {
            background: rgba(0, 255, 204, 0.5);
            box-shadow: 0 0 10px #00ffcc;
        }

        #cursor2 {
            background: rgba(255, 0, 100, 0.5);
            box-shadow: 0 0 10px #ff0064;
        }

        /* æ“ä½œæç¤º */
        #guide {
            position: absolute;
            bottom: 30px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            color: #ccc;
            pointer-events: none;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="header">
        <h1>PS5 Touch Gallery</h1>
        <div id="status-bar">ç­‰å¾…è¿æ¥... (è¯·ä½¿ç”¨ USB)</div>
        <button onclick="connectHandler()">âš¡ è¿æ¥æ‰‹æŸ„</button>
    </div>

    <!-- è§†å£ -->
    <div id="viewport">
        <!-- ä½ çš„å›¾ç‰‡ï¼Œæ·»åŠ äº† onerror ä»¥é˜²å›¾ç‰‡åŠ è½½å¤±è´¥ -->
        <img id="target-image" src="recraftv3.webp" alt="Preview Image"
            onerror="this.onerror=null; this.src='https://placehold.co/800x600/222/999?text=Image+Not+Found';">
    </div>

    <!-- è§¦æ§ç‚¹å…‰æ ‡ (æ˜¾ç¤ºæ‰‹æŒ‡ä½ç½®) -->
    <div id="cursor1" class="cursor"></div>
    <div id="cursor2" class="cursor"></div>

    <div id="guide">
        âœŒï¸ <b>åŒæŒ‡æåˆ</b> ç¼©æ”¾å›¾ç‰‡ (ä¸­å¿ƒå›ºå®š)<br>
        ğŸ‘‹ <b>æ¾å¼€åŒæ‰‹</b> è‡ªåŠ¨æ¢å¤åŸå§‹å¤§å°
    </div>

    <script>
        let device;

        // å˜æ¢çŠ¶æ€
        let transform = {
            scale: 1,
            x: 0,
            y: 0
        };

        // ä¸Šä¸€å¸§çš„è§¦æ§æ•°æ®
        let prevTouchState = {
            t1: null,
            t2: null,
            dist: 0,
            centerX: 0,
            centerY: 0
        };

        // äº¤äº’çŠ¶æ€æ ‡è®°
        let isInteracting = false;

        const imgEl = document.getElementById('target-image');
        const statusEl = document.getElementById('status-bar');
        const c1 = document.getElementById('cursor1');
        const c2 = document.getElementById('cursor2');

        async function connectHandler() {
            try {
                if (!navigator.hid) throw new Error("æµè§ˆå™¨ä¸æ”¯æŒ WebHID");
                const devices = await navigator.hid.requestDevice({
                    filters: [{ vendorId: 0x054c, productId: 0x0ce6 }]
                });

                if (devices.length > 0) {
                    device = devices[0];
                    await device.open();
                    device.addEventListener("inputreport", handleInput);
                    await initDevice();
                    statusEl.innerText = `âœ… å·²è¿æ¥: ${device.productName}`;
                    statusEl.style.color = "#0f0";
                }
            } catch (err) {
                console.error(err);
                alert("è¿æ¥å¤±è´¥: " + err.message);
            }
        }

        async function initDevice() {
            const data = new Uint8Array(47).fill(0);
            data[0] = 0x02; data[1] = 0xFF;
            data[42] = 0; data[43] = 255; data[44] = 255; // LED
            try { await device.sendReport(0x02, data); } catch (e) { }
        }

        function handleInput(event) {
            const { data, reportId } = event;
            if (reportId !== 0x01) return;

            let offset = (data.getUint8(0) === 0x01) ? 1 : 0;

            const t1 = parseTouch(data, 32 + offset);
            const t2 = parseTouch(data, 36 + offset);

            updateCursors(t1, t2);
            processGesture(t1, t2);
        }

        function parseTouch(data, startIndex) {
            if (data.byteLength < startIndex + 4) return null;
            const info = data.getUint8(startIndex);
            const isActive = !(info & 0x80);

            if (!isActive) return null;

            const b1 = data.getUint8(startIndex + 1);
            const b2 = data.getUint8(startIndex + 2);
            const b3 = data.getUint8(startIndex + 3);

            const rawX = ((b2 & 0x0F) << 8) | b1;
            const rawY = (b3 << 4) | ((b2 & 0xF0) >> 4);

            return { x: rawX, y: rawY, id: info & 0x7F };
        }

        function updateCursors(t1, t2) {
            const mapX = (x) => (x / 1920) * window.innerWidth;
            const mapY = (y) => (y / 1080) * window.innerHeight;

            if (t1) {
                c1.style.display = 'block';
                c1.style.left = mapX(t1.x) + 'px';
                c1.style.top = mapY(t1.y) + 'px';
            } else {
                c1.style.display = 'none';
            }

            if (t2) {
                c2.style.display = 'block';
                c2.style.left = mapX(t2.x) + 'px';
                c2.style.top = mapY(t2.y) + 'px';
            } else {
                c2.style.display = 'none';
            }
        }

        function processGesture(t1, t2) {
            // åŒæŒ‡æ“ä½œä¸­
            if (t1 && t2) {
                // æ ‡è®°ä¸ºæ­£åœ¨äº¤äº’
                isInteracting = true;

                // äº¤äº’æ—¶ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œä¿è¯è·Ÿæ‰‹æ€§
                imgEl.style.transition = 'none';

                const currDist = Math.hypot(t2.x - t1.x, t2.y - t1.y);
                const currCenterX = (t1.x + t2.x) / 2;
                const currCenterY = (t1.y + t2.y) / 2;

                if (prevTouchState.t1 && prevTouchState.t2) {
                    // --- ç¼©æ”¾ ---
                    if (prevTouchState.dist > 0) {
                        const zoomFactor = currDist / prevTouchState.dist;
                        transform.scale *= zoomFactor;
                        // é™åˆ¶ç¼©æ”¾èŒƒå›´
                        transform.scale = Math.max(0.5, Math.min(transform.scale, 4.0));
                    }

                    // --- æ‹–æ‹½ (å¦‚æœéœ€è¦å®Œå…¨å›ºå®šå›¾ç‰‡ä½ç½®ä¸è®©åŠ¨ï¼Œå¯æ³¨é‡Šä¸‹é¢ä¸¤è¡Œ) ---
                    // è¿™é‡Œä¿ç•™äº†æ‹–æ‹½ï¼Œä½†å› ä¸º transform-origin æ˜¯ centerï¼Œæ‰€ä»¥ç¼©æ”¾æœ¬èº«ä¸ä¼šå¯¼è‡´ä½ç§»
                    const deltaX = (currCenterX - prevTouchState.centerX) * 1.5;
                    const deltaY = (currCenterY - prevTouchState.centerY) * 1.5;
                    transform.x += deltaX;
                    transform.y += deltaY;
                }

                prevTouchState.dist = currDist;
                prevTouchState.centerX = currCenterX;
                prevTouchState.centerY = currCenterY;

                statusEl.innerText = `ğŸ” ç¼©æ”¾ä¸­... å€ç‡: ${transform.scale.toFixed(2)}`;

                // åº”ç”¨å˜æ¢
                applyTransform();

            } else {
                // æ‰‹æŒ‡æ•°é‡ä¸è¶³2ä¸ªï¼ˆæ¾å¼€ï¼‰
                if (isInteracting) {
                    // åˆšåˆšæ¾å¼€åŒæŒ‡ -> è§¦å‘å›å¼¹
                    isInteracting = false;
                    resetImage();
                    statusEl.innerText = "â†©ï¸ å·²å¤ä½";
                } else {
                    // é—²ç½®çŠ¶æ€
                    prevTouchState.dist = 0;
                }
            }

            prevTouchState.t1 = t1;
            prevTouchState.t2 = t2;
        }

        function applyTransform() {
            requestAnimationFrame(() => {
                imgEl.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
            });
        }

        // å¤ä½å‡½æ•°ï¼šå¸¦åŠ¨ç”»å›å½’åŸå§‹çŠ¶æ€
        function resetImage() {
            // å¯ç”¨å¼¹æ€§åŠ¨ç”»
            imgEl.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            // é‡ç½®æ•°æ®
            transform = { scale: 1, x: 0, y: 0 };

            // åº”ç”¨é‡ç½®
            requestAnimationFrame(() => {
                imgEl.style.transform = `translate(0px, 0px) scale(1)`;
            });
        }

    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>PS5 è§¦æ§æ¿å›¾ç‰‡ç¼©æ”¾æ¼”ç¤º</title>
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        #header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            color: #00ffcc;
        }

        #status-bar {
            font-family: monospace;
            font-size: 14px;
            color: #aaa;
        }

        button {
            padding: 8px 20px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #00aaff;
        }

        /* å›¾ç‰‡å®¹å™¨ */
        #viewport {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: radial-gradient(circle, #222 1px, transparent 1px);
            background-size: 30px 30px;
            /* ç½‘æ ¼èƒŒæ™¯ */
            position: relative;
        }

        /* å›¾ç‰‡æœ¬èº« */
        #target-image {
            max-width: 80%;
            max-height: 80%;
            /* å…³é”®ï¼šè®¾ç½®å˜æ¢åŸç‚¹ä¸ºä¸­å¿ƒï¼Œç¡®ä¿ç¼©æ”¾æ—¶ä»¥ä¸­å¿ƒä¸ºåŸºå‡† */
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            /* é»˜è®¤æ— è¿‡æ¸¡ï¼ŒJSæ§åˆ¶åŠ¨æ€è¿‡æ¸¡ */
            transition: none;
            will-change: transform;
            user-select: none;
            -webkit-user-drag: none;
        }

        /* è§¦æ§å…‰æ ‡ (è°ƒè¯•ç”¨) */
        .cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            z-index: 200;
        }

        #cursor1 {
            background: rgba(0, 255, 204, 0.5);
            box-shadow: 0 0 10px #00ffcc;
        }

        #cursor2 {
            background: rgba(255, 0, 100, 0.5);
            box-shadow: 0 0 10px #ff0064;
        }

        /* æ“ä½œæç¤º */
        #guide {
            position: absolute;
            bottom: 30px;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            color: #ccc;
            pointer-events: none;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="header">
        <h1>PS5 Touch Gallery</h1>
        <div id="status-bar">ç­‰å¾…è¿æ¥... (è¯·ä½¿ç”¨ USB)</div>
        <button onclick="connectHandler()">âš¡ è¿æ¥æ‰‹æŸ„</button>
    </div>

    <!-- è§†å£ -->
    <div id="viewport">
        <!-- ä½ çš„å›¾ç‰‡ï¼Œæ·»åŠ äº† onerror ä»¥é˜²å›¾ç‰‡åŠ è½½å¤±è´¥ -->
        <img id="target-image" src="recraftv3.webp" alt="Preview Image"
            onerror="this.onerror=null; this.src='https://placehold.co/800x600/222/999?text=Image+Not+Found';">
    </div>

    <!-- è§¦æ§ç‚¹å…‰æ ‡ (æ˜¾ç¤ºæ‰‹æŒ‡ä½ç½®) -->
    <div id="cursor1" class="cursor"></div>
    <div id="cursor2" class="cursor"></div>

    <div id="guide">
        âœŒï¸ <b>åŒæŒ‡æåˆ</b> ç¼©æ”¾å›¾ç‰‡ (ä¸­å¿ƒå›ºå®š)<br>
        ğŸ‘‹ <b>æ¾å¼€åŒæ‰‹</b> è‡ªåŠ¨æ¢å¤åŸå§‹å¤§å°
    </div>

    <script>
        let device;

        // å˜æ¢çŠ¶æ€
        let transform = {
            scale: 1,
            x: 0,
            y: 0
        };

        // ä¸Šä¸€å¸§çš„è§¦æ§æ•°æ®
        let prevTouchState = {
            t1: null,
            t2: null,
            dist: 0,
            centerX: 0,
            centerY: 0
        };

        // äº¤äº’çŠ¶æ€æ ‡è®°
        let isInteracting = false;

        const imgEl = document.getElementById('target-image');
        const statusEl = document.getElementById('status-bar');
        const c1 = document.getElementById('cursor1');
        const c2 = document.getElementById('cursor2');

        async function connectHandler() {
            try {
                if (!navigator.hid) throw new Error("æµè§ˆå™¨ä¸æ”¯æŒ WebHID");
                const devices = await navigator.hid.requestDevice({
                    filters: [{ vendorId: 0x054c, productId: 0x0ce6 }]
                });

                if (devices.length > 0) {
                    device = devices[0];
                    await device.open();
                    device.addEventListener("inputreport", handleInput);
                    await initDevice();
                    statusEl.innerText = `âœ… å·²è¿æ¥: ${device.productName}`;
                    statusEl.style.color = "#0f0";
                }
            } catch (err) {
                console.error(err);
                alert("è¿æ¥å¤±è´¥: " + err.message);
            }
        }

        async function initDevice() {
            const data = new Uint8Array(47).fill(0);
            data[0] = 0x02; data[1] = 0xFF;
            data[42] = 0; data[43] = 255; data[44] = 255; // LED
            try { await device.sendReport(0x02, data); } catch (e) { }
        }

        function handleInput(event) {
            const { data, reportId } = event;
            if (reportId !== 0x01) return;

            let offset = (data.getUint8(0) === 0x01) ? 1 : 0;

            const t1 = parseTouch(data, 32 + offset);
            const t2 = parseTouch(data, 36 + offset);

            updateCursors(t1, t2);
            processGesture(t1, t2);
        }

        function parseTouch(data, startIndex) {
            if (data.byteLength < startIndex + 4) return null;
            const info = data.getUint8(startIndex);
            const isActive = !(info & 0x80);

            if (!isActive) return null;

            const b1 = data.getUint8(startIndex + 1);
            const b2 = data.getUint8(startIndex + 2);
            const b3 = data.getUint8(startIndex + 3);

            const rawX = ((b2 & 0x0F) << 8) | b1;
            const rawY = (b3 << 4) | ((b2 & 0xF0) >> 4);

            return { x: rawX, y: rawY, id: info & 0x7F };
        }

        function updateCursors(t1, t2) {
            const mapX = (x) => (x / 1920) * window.innerWidth;
            const mapY = (y) => (y / 1080) * window.innerHeight;

            if (t1) {
                c1.style.display = 'block';
                c1.style.left = mapX(t1.x) + 'px';
                c1.style.top = mapY(t1.y) + 'px';
            } else {
                c1.style.display = 'none';
            }

            if (t2) {
                c2.style.display = 'block';
                c2.style.left = mapX(t2.x) + 'px';
                c2.style.top = mapY(t2.y) + 'px';
            } else {
                c2.style.display = 'none';
            }
        }

        function processGesture(t1, t2) {
            // åŒæŒ‡æ“ä½œä¸­
            if (t1 && t2) {
                // æ ‡è®°ä¸ºæ­£åœ¨äº¤äº’
                isInteracting = true;

                // äº¤äº’æ—¶ç§»é™¤è¿‡æ¸¡åŠ¨ç”»ï¼Œä¿è¯è·Ÿæ‰‹æ€§
                imgEl.style.transition = 'none';

                const currDist = Math.hypot(t2.x - t1.x, t2.y - t1.y);
                const currCenterX = (t1.x + t2.x) / 2;
                const currCenterY = (t1.y + t2.y) / 2;

                if (prevTouchState.t1 && prevTouchState.t2) {
                    // --- ç¼©æ”¾ ---
                    if (prevTouchState.dist > 0) {
                        const zoomFactor = currDist / prevTouchState.dist;
                        transform.scale *= zoomFactor;
                        // é™åˆ¶ç¼©æ”¾èŒƒå›´
                        transform.scale = Math.max(0.5, Math.min(transform.scale, 4.0));
                    }

                    // --- æ‹–æ‹½ (å¦‚æœéœ€è¦å®Œå…¨å›ºå®šå›¾ç‰‡ä½ç½®ä¸è®©åŠ¨ï¼Œå¯æ³¨é‡Šä¸‹é¢ä¸¤è¡Œ) ---
                    // è¿™é‡Œä¿ç•™äº†æ‹–æ‹½ï¼Œä½†å› ä¸º transform-origin æ˜¯ centerï¼Œæ‰€ä»¥ç¼©æ”¾æœ¬èº«ä¸ä¼šå¯¼è‡´ä½ç§»
                    const deltaX = (currCenterX - prevTouchState.centerX) * 1.5;
                    const deltaY = (currCenterY - prevTouchState.centerY) * 1.5;
                    transform.x += deltaX;
                    transform.y += deltaY;
                }

                prevTouchState.dist = currDist;
                prevTouchState.centerX = currCenterX;
                prevTouchState.centerY = currCenterY;

                statusEl.innerText = `ğŸ” ç¼©æ”¾ä¸­... å€ç‡: ${transform.scale.toFixed(2)}`;

                // åº”ç”¨å˜æ¢
                applyTransform();

            } else {
                // æ‰‹æŒ‡æ•°é‡ä¸è¶³2ä¸ªï¼ˆæ¾å¼€ï¼‰
                if (isInteracting) {
                    // åˆšåˆšæ¾å¼€åŒæŒ‡ -> è§¦å‘å›å¼¹
                    isInteracting = false;
                    resetImage();
                    statusEl.innerText = "â†©ï¸ å·²å¤ä½";
                } else {
                    // é—²ç½®çŠ¶æ€
                    prevTouchState.dist = 0;
                }
            }

            prevTouchState.t1 = t1;
            prevTouchState.t2 = t2;
        }

        function applyTransform() {
            requestAnimationFrame(() => {
                imgEl.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
            });
        }

        // å¤ä½å‡½æ•°ï¼šå¸¦åŠ¨ç”»å›å½’åŸå§‹çŠ¶æ€
        function resetImage() {
            // å¯ç”¨å¼¹æ€§åŠ¨ç”»
            imgEl.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';

            // é‡ç½®æ•°æ®
            transform = { scale: 1, x: 0, y: 0 };

            // åº”ç”¨é‡ç½®
            requestAnimationFrame(() => {
                imgEl.style.transform = `translate(0px, 0px) scale(1)`;
            });
        }

    </script>
</body>

</html>